# Main Flow

> [â† Response](./04_Response_H1-H5.md) | [INDEX](../INDEX.md)

---

## Overview

Ð£Ð¿Ñ€Ð¾Ñ‰Ñ‘Ð½Ð½Ñ‹Ð¹ flow: LLM Ð¾Ð±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ð½Ð°Ð¿Ñ€ÑÐ¼ÑƒÑŽ.

---

## Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  USER: "Ð Ð°ÑÑÑ‡Ð¸Ñ‚Ð°Ð¹ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ, Ð²Ñ‹Ñ€ÑƒÑ‡ÐºÐ° 500 Ð¼Ð»Ð½"          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. GET CONTEXT â”‚ RAG (Qdrant) â†’ ISA 320 chunks             â”‚
â”‚                 â”‚ PostgreSQL â†’ project data                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. LLM PROCESS â”‚ Claude Ð¿Ð¾Ð½Ð¸Ð¼Ð°ÐµÑ‚ Ð·Ð°Ð¿Ñ€Ð¾Ñ                    â”‚
â”‚                 â”‚ Ð’Ñ‹Ð·Ñ‹Ð²Ð°ÐµÑ‚ tool: calculate_materiality()    â”‚
â”‚                 â”‚ Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€ÑƒÐµÑ‚ Ð¾Ñ‚Ð²ÐµÑ‚                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. PRESENT â”‚ Response Ñ H1 (Ñ‚ÐµÐºÑÑ‚) + H2 (ÐºÐ½Ð¾Ð¿ÐºÐ¸) + H3 (Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð°) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. CONFIRM â”‚ User clicks [ðŸ’¾ Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ]                    â”‚
â”‚             â”‚ âš ï¸ LLM ÐÐ˜ÐšÐžÐ“Ð”Ð Ð½Ðµ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÑ‚ Ð±ÐµÐ· Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. SAVE â”‚ save_materiality() â†’ DB with confirmed_by        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. FOLLOW-UP â”‚ H5: "âœ… Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¾. ÐŸÐµÑ€ÐµÐ¹Ñ‚Ð¸ Ðº Ñ€Ð¸ÑÐºÐ°Ð¼?"       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Step Details

### Step 1: GET CONTEXT

**Component:** RAG Engine (Qdrant)

```python
# RAG search for relevant context
rag_context = await rag_engine.search(
    query=user_message,
    top_k=10
)

# Get project context from PostgreSQL
project_context = await get_project_context(project_id)
```

---

### Step 2: LLM PROCESS

**Component:** Claude API + Tools

```python
# Build prompt with context
prompt = prompt_builder.build(
    user_message=user_message,
    rag_context=rag_context,
    project_context=project_context
)

# LLM processes and may call tools
response = await llm.generate(
    prompt=prompt,
    tools=[
        calculate_materiality,
        calculate_sample_size,
        assess_legal_matter,
        search_knowledge,
        generate_document
    ]
)

# If LLM called a tool, execute it
if response.tool_calls:
    result = await function_executor.execute(response.tool_calls)
    # LLM formats final response with result
```

**Ð’Ð°Ð¶Ð½Ð¾:** LLM ÑÐ°Ð¼ Ð¿Ð¾Ð½Ð¸Ð¼Ð°ÐµÑ‚ Ñ‡Ñ‚Ð¾ Ð½ÑƒÐ¶Ð½Ð¾ â€” Ð±ÐµÐ· Ð¶Ñ‘ÑÑ‚ÐºÐ¾Ð¹ ÐºÐ»Ð°ÑÑÐ¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸ Ð¸Ð½Ñ‚ÐµÐ½Ñ‚Ð¾Ð².

---

### Step 3: PRESENT

**Component:** Response Formatter (H1-H5)

```
User sees:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ð Ð°ÑÑÑ‡Ð¸Ñ‚Ð°Ð» ÑÑƒÑ‰ÐµÑÑ‚Ð²ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ Ð¿Ð¾ ISA 320:   â”‚
â”‚                                        â”‚
â”‚ | ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÐµÐ»ÑŒ | Ð—Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ     |          â”‚
â”‚ |------------|--------------|          â”‚
â”‚ | OM         | 15 000 000 â‚½ |          â”‚
â”‚ | PM         | 9 750 000 â‚½  |          â”‚
â”‚ | CT         | 750 000 â‚½    |          â”‚
â”‚                                        â”‚
â”‚ [ðŸ’¾ Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ]  [âŒ ÐžÑ‚Ð¼ÐµÐ½Ð°]            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Step 4: CONFIRM

**User clicks [ðŸ’¾ Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ]**

ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ð¾: LLM Ð½Ð¸ÐºÐ¾Ð³Ð´Ð° Ð½Ðµ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÑ‚ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸!

---

### Step 5: SAVE

**Component:** API Action Handler

```python
@router.post("/actions/save-materiality")
async def save_materiality_action(
    data: MaterialitySaveRequest,
    current_user: User = Depends(get_current_user)
):
    record = await save_materiality(
        project_id=data.project_id,
        data=data,
        confirmed_by=current_user.id  # ÐžÐ‘Ð¯Ð—ÐÐ¢Ð•Ð›Ð¬ÐÐž!
    )
    return {"success": True, "record_id": record.id}
```

---

### Step 6: FOLLOW-UP

**Component:** H5 (Redirect suggestion)

```
User sees:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… Ð¡ÑƒÑ‰ÐµÑÑ‚Ð²ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð°.           â”‚
â”‚                                        â”‚
â”‚ ÐŸÐµÑ€ÐµÐ¹Ñ‚Ð¸ Ðº Ð¾Ñ†ÐµÐ½ÐºÐµ Ñ€Ð¸ÑÐºÐ¾Ð²?               â”‚
â”‚                                        â”‚
â”‚ [Ð”Ð°, Ð¿ÐµÑ€ÐµÐ¹Ñ‚Ð¸]  [ÐÐµÑ‚, Ð¾ÑÑ‚Ð°Ñ‚ÑŒÑÑ]         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Sequence Diagram

```
User      Frontend     API        Qdrant     LLM        DB
 â”‚            â”‚          â”‚           â”‚         â”‚         â”‚
 â”‚â”€â”€messageâ”€â”€>â”‚          â”‚           â”‚         â”‚         â”‚
 â”‚            â”‚â”€â”€POSTâ”€â”€â”€>â”‚           â”‚         â”‚         â”‚
 â”‚            â”‚          â”‚â”€â”€searchâ”€â”€>â”‚         â”‚         â”‚
 â”‚            â”‚          â”‚<â”€â”€chunksâ”€â”€â”‚         â”‚         â”‚
 â”‚            â”‚          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€promptâ”€â”€>â”‚        â”‚
 â”‚            â”‚          â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€responseâ”€â”‚        â”‚
 â”‚            â”‚<â”€â”€JSONâ”€â”€â”€â”‚           â”‚         â”‚         â”‚
 â”‚<â”€â”€renderâ”€â”€â”€â”‚          â”‚           â”‚         â”‚         â”‚
 â”‚            â”‚          â”‚           â”‚         â”‚         â”‚
 â”‚â”€â”€[Save]â”€â”€â”€>â”‚          â”‚           â”‚         â”‚         â”‚
 â”‚            â”‚â”€â”€POSTâ”€â”€â”€>â”‚           â”‚         â”‚         â”‚
 â”‚            â”‚          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€saveâ”€>â”‚
 â”‚            â”‚          â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€okâ”€â”€â”€â”‚
 â”‚            â”‚<â”€successâ”€â”‚           â”‚         â”‚         â”‚
 â”‚<â”€confirmâ”€â”€â”€â”‚          â”‚           â”‚         â”‚         â”‚
```

---

## Key Principles

1. **LLM Ð¾Ð±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ Ð½Ð°Ð¿Ñ€ÑÐ¼ÑƒÑŽ** â€” Ð±ÐµÐ· Ð¶Ñ‘ÑÑ‚ÐºÐ¾Ð¹ ÐºÐ»Ð°ÑÑÐ¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸ Ð¸Ð½Ñ‚ÐµÐ½Ñ‚Ð¾Ð²
2. **Tools Ð´Ð»Ñ Ñ€Ð°ÑÑ‡Ñ‘Ñ‚Ð¾Ð²** â€” LLM Ð½Ðµ ÑÑ‡Ð¸Ñ‚Ð°ÐµÑ‚ ÑÐ°Ð¼, Ð²Ñ‹Ð·Ñ‹Ð²Ð°ÐµÑ‚ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸
3. **ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ðµ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾** â€” Ð½Ð¸ÐºÐ°ÐºÐ¸Ñ… Ð·Ð°Ð¿Ð¸ÑÐµÐ¹ Ð² Ð‘Ð” Ð±ÐµÐ· ÐºÐ½Ð¾Ð¿ÐºÐ¸
4. **confirmed_by Ð²ÑÐµÐ³Ð´Ð°** â€” audit trail Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð¹ Ð·Ð°Ð¿Ð¸ÑÐ¸

---

## Related Docs

- [Engine](./01_Engine_F1-F6.md) â€” ÐšÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ñ‹
- [Functions](./03_Functions_I1-I10.md) â€” Tools (Ð±Ð¸Ð·Ð½ÐµÑ-Ð»Ð¾Ð³Ð¸ÐºÐ°)
- [API Endpoints](../api/01_Endpoints.md) â€” REST API
